# 클러스터(메인–서브) 보안 정리

"아무 노드나 붙으면 안 된다"는 관점에서, **누가 누구를 검증하는지**와 **남는 위험·보완점**을 정리한 문서입니다.

---

## 1. 현재 구현 요약

### 1.1 Sub → Main (등록·통계)

| 항목 | 내용 |
|------|------|
| **인증 방식** | `CLUSTER_SECRET` + 타임스탬프 기반 HMAC-SHA256 |
| **엔드포인트** | `POST /cluster/register`, `POST /cluster/stats` |
| **검증** | Main이 `verify_cluster_auth_token(secret, timestamp, provided_token)`으로 검증. 일치해야만 등록/통계 수락 |

→ **CLUSTER_SECRET을 모르는 노드는 Main에 등록하거나 통계를 보낼 수 없음.** (아무 노드나 “Sub로 붙는” 것은 차단됨)

### 1.2 Main → Sub (발견 단계)

| 항목 | 내용 |
|------|------|
| **발견 방법** | mDNS 광고, 네트워크 스캔(/health), 공통 IP 등 |
| **검증** | **없음.** “/health 응답에 mode=main 있다” 정도만 확인 |

→ **Sub 입장에서는 “진짜 우리 메인인지”를 검증하지 않음.** 발견된 URL이 악의적인 서버일 수 있음.

### 1.3 기타

- **Unregister** (`POST /cluster/unregister`): `node_id`만 보냄. **인증 없음.**  
  → 악의적 클라이언트가 특정 `node_id`를 짚어서 해제 요청을 보낼 수 있음.

---

## 2. 보안 관점 정리

### 2.1 잘 되어 있는 부분

- **Main이 “아무 Sub나” 받지 않음**  
  - 등록·통계 모두 `CLUSTER_SECRET` 기반 HMAC 검증.  
  - 시크릿을 모르면 Sub 역할로 붙을 수 없음.
- **시크릿 관리**  
  - `CLUSTER_SECRET`은 .env 등으로 관리, 코드/클라이언트에 노출하지 않는 구조가 전제됨.

### 2.2 부족한 부분·위험

1. **발견 단계에서 Main 정체성 미검증**
   - Sub는 “/health로 main 응답하는 아무 서버”에 등록 시도를 함.
   - 공격자가 **같은 네트워크에서 가짜 Main**을 띄우고 mDNS/스캔으로 먼저 발견되게 하면, Sub가 **가짜 Main**에 붙을 수 있음.
   - 이때 Sub는 등록 요청에 **CLUSTER_SECRET 기반 토큰**을 보내므로, **시크릿이 유출될 위험**이 있음 (가짜 Main이 토큰을 저장·재사용 시도 등).
   - **정리**: “아무 노드(가짜 Main)나 붙지 않게” 하려면 **Sub가 연결 대상이 우리 Main인지 검증**하는 절차가 필요함.

2. **Unregister 인증 없음**
   - `node_id`만 알면 누구나 해당 노드를 클러스터에서 해제 요청 가능.
   - **정리**: unregister도 **동일한 HMAC 인증**을 요구하는 편이 안전함.

3. **타임스탬프 유효 구간 미검증 (리플레이)**
   - HMAC은 `(timestamp, secret)`으로 생성되지만, **과거 timestamp를 허용**하면 옛 토큰을 재사용할 수 있음.
   - **정리**: timestamp에 **유효 시간(예: ±60초)**을 두고, 그 밖의 요청은 거부하는 것이 좋음.

4. **Sub 허용 목록(allowlist) 없음**
   - CLUSTER_SECRET만 알면 어떤 호스트라도 Sub로 등록 가능.
   - **정리**: 운영 환경에서는 **허용할 node_id 또는 IP/호스트 목록**을 두는 것을 고려할 수 있음.

---

## 3. 권장 보완 방향

| 우선순위 | 항목 | 내용 |
|----------|------|------|
| **높음** | **Unregister 인증** | `POST /cluster/unregister`에도 `auth_token` + `timestamp` 필수, Main이 HMAC 검증 후 해당 `node_id`만 해제 |
| **높음** | **타임스탬프 유효 구간** | 등록/통계/unregister 공통으로, 요청 시각이 현재 시각 ±N초(예: 60초) 안인지 검사. 벗어나면 403 |
| **중간** | **Main 정체성 검증(선택)** | Sub가 발견된 URL에 “Main 증명” 요청(예: GET /cluster/prove?nonce=xxx → Main이 CLUSTER_SECRET으로 서명한 값 반환). Sub는 그 서명을 검증한 뒤에만 등록 시도. (구현 복잡도 대비 효과는 환경에 따라 선택) |
| **낮음** | **Sub allowlist** | Main 설정으로 “등록 허용 node_id 목록” 또는 “등록 허용 IP/대역” 관리. 목록에 없으면 403 |

---

## 4. 요약

- **“아무 노드나 Sub로 붙는 것”**  
  → 이미 **CLUSTER_SECRET HMAC**으로 막고 있음. (Main이 아무 Sub나 받지 않음.)
- **“Sub가 아무 Main(노드)에나 붙는 것”**  
  → **발견 단계에서는 검증이 없음.** 가짜 Main에 붙거나, 시크릿이 노출될 위험이 있으므로, **Unregister 인증·타임스탬프 유효 구간**을 먼저 보완하고, 여유 있으면 **Main 정체성 검증**을 고려하는 것이 좋음.

위 보완을 반영하면 “아무 노드나 붙으면 안 되게” 하는 보안이 한 단계 더 강화됩니다.
