# TOTP(2FA) 도입 설계

Google OTP라고 부르지만 **표준 TOTP(RFC 6238)**라서 **굳이 Google 앱이 아니어도 됨.**  
QR로 등록하고, 6자리 코드를 입력하는 방식이면 **어떤 TOTP 호환 앱**이든 사용 가능합니다.

## 구현 요약 (현재)

- **.env**: 최초 설정(GUI) 시 `TOTP_SECRET` 자동 생성·기재. 서버 기동 시 이 값을 사용해 TOTP 검증.
- **QR 등록**: `GET /cluster/totp-setup` 에서 프로비저닝 URI·QR 이미지 반환. 앱에서 스캔 후 6자리 코드 사용.
- **Sub 등록**: `TOTP_SECRET`이 설정된 경우 `POST /cluster/register` 시 `totp_code`(6자리) 필수. Sub는 동일 시크릿으로 현재 코드 생성해 전송.
- **Android/디바이스 연동**: `POST /api/auth/device-token` 에 `totp_code` 전달 시 검증 후 단기 JWT 발급. 앱에서 이 토큰으로 API 호출.

---

## 1. TOTP란 / 앱 호환성

- **TOTP** = Time-based One-Time Password. 30초마다 바뀌는 6자리 코드.
- **표준**: RFC 6238. 구현만 맞으면 앱 종류와 무관하게 동일하게 동작.
- **사용 가능한 앱 예시**
  - Google Authenticator
  - Microsoft Authenticator
  - Authy
  - 1Password / Bitwarden 등 비밀번호 관리자 내 OTP
  - 기타 `otpauth://` QR을 스캔하고 6자리 코드를 찍어주는 앱 전부

→ **“Google OTP를 이용한다” = TOTP를 이용한다**라고 보면 되고, **앱은 QR만 스캔할 수 있으면 됨.**

---

## 2. 흐름 (QR 등록 → 로그인/인증 시 코드 입력)

1. **등록(최초 1회)**
   - 서버가 **비밀 키(secret)** 생성.
   - `otpauth://totp/...?secret=...` 형태의 **프로비저닝 URI** 생성 → **QR 코드**로 표시.
   - 사용자가 **아무 TOTP 앱**으로 QR 스캔 → 앱이 secret 저장, 30초마다 6자리 코드 표시.
   - (선택) 사용자가 **코드 한 번 입력**해 서버에 보내면, 서버가 `verify(코드)`로 검증 후 “이 사용자 OTP 등록 완료”로 저장.

2. **이후 인증**
   - 로그인/중요 동작 시 **6자리 코드 입력** 요청.
   - 서버는 저장해 둔 secret + 현재 시간으로 기대값 계산 후, 입력값과 비교 (`verify`).

---

## 3. AIRClass에서 쓸 만한 위치

| 대상 | 용도 | 비고 |
|------|------|------|
| **관리자/선생님 로그인** | 로그인 시 비밀번호 + TOTP 코드 요청 | 가장 일반적인 2FA. QR 한 번 등록 후 로그인할 때마다 코드 입력. |
| **클러스터(Sub 등록)** | Sub가 Main에 등록할 때, “등록 허용 코드”를 TOTP로 검증 | CLUSTER_SECRET만으로는 “아무나” 가입 가능하므로, 등록 시점에 TOTP 한 번 더 요구하면 강화됨. (선택) |
| **중요 설정 변경** | 예: 클러스터 비밀번호 변경, 노드 삭제 등 | 해당 API 호출 시 TOTP 코드 필수. |

**추천**: 먼저 **관리자/선생님 로그인 2FA**부터 적용하고, 필요하면 클러스터 등록·중요 설정에 확장하는 식이 구현 부담이 적음.

---

## 4. 구현 시 참고 (백엔드)

- **라이브러리**: `pyotp` (TOTP 생성·검증) + QR 이미지가 필요하면 `qrcode` 등.
- **등록**: `pyotp.TOTP(secret).provisioning_uri(name, issuer)` → 이 URI를 QR로 인코딩해 프론트에 전달.
- **검증**: `pyotp.TOTP(secret).verify(사용자_입력_코드)` (일정 시간 창 내 코드만 허용).

secret은 **사용자별로 DB/설정에 안전하게 저장**, 노출되지 않도록 함.

---

## 5. 요약

- **Google OTP 앱 필수 아님.** QR 등록하고 6자리 코드 쓰는 **TOTP 호환 앱**이면 모두 사용 가능.
- **QR로 등록하고, 로그인/인증 시 코드 입력**하는 구조만 맞추면 됨.
- AIRClass에는 **관리자/선생님 로그인 2FA**로 도입하는 것을 우선 추천하고, 필요 시 클러스터·중요 API에 확장할 수 있음.
