# AIRClass Docker Compose - FastAPI-controlled LiveKit Architecture
# 각 노드(main/sub)가 FastAPI + LiveKit을 함께 실행
# FastAPI가 노드 역할에 따라 LiveKit 설정을 동적으로 생성/관리
#
# 사용법:
#   기본 실행 (Main 1대): docker-compose up main frontend mongodb redis
#   Sub 노드 추가: docker-compose up -d sub-1
#   종료: docker-compose down
#
# 포트 범위:
#   Main Node - FastAPI: 8000, LiveKit: 7880, RTC: 50000-50020
#   Sub Node 1 - FastAPI: 8001, LiveKit: 7890, RTC: 51000-51020
#   Sub Node 2 - FastAPI: 8002, LiveKit: 7900, RTC: 52000-52020

version: '3.8'

services:
  # ============================================
  # MongoDB - 데이터베이스
  # ============================================
  mongodb:
    image: mongo:7
    container_name: airclass-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: airclass
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    networks:
      - airclass-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    labels:
      - "airclass.role=database"

  # ============================================
  # Redis - 메시지 브로커 & 캐시
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: airclass-redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - airclass-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      - "airclass.role=redis"

  # ============================================
  # Main Node - FastAPI + LiveKit (통합 노드)
  # FastAPI가 LiveKit 서버를 subprocess로 실행/관리
  # ============================================
  main:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-main-node
    environment:
      # 클러스터 설정
      MODE: main
      NODE_NAME: main
      NODE_HOST: main
      NODE_PORT: 8000
      MAIN_API_PORT: ${MAIN_API_PORT}
      
      # LiveKit 설정
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET}
      LIVEKIT_URL: ws://localhost:7880  # 컨테이너 내부 주소
      LIVEKIT_PUBLIC_URL: ws://${SERVER_IP}:7880  # 브라우저 접근용 (SERVER_IP와 동일)
      LIVEKIT_BINARY: /usr/local/bin/livekit-server
      LIVEKIT_PORT: 7880
      LIVEKIT_RTC_PORT_START: 50000
      LIVEKIT_RTC_PORT_END: 50020
      
      # 녹화 설정
      RECORDING_ENABLED: "true"
      RECORDING_DIR: /recordings
      SCREENSHOT_INTERVAL: 10
      
      # 보안 설정
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      CLUSTER_SECRET: ${CLUSTER_SECRET}
      
      # 네트워크 설정 (스크립트/GUI에서 SERVER_IP만 주입하면 됨)
      CORS_ORIGINS: ${CORS_ORIGINS}
      SERVER_IP: ${SERVER_IP}
      
      # Redis & MongoDB
      REDIS_URL: redis://redis:6379
      MONGO_URL: mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@mongodb:27017/airclass?authSource=admin
      
      # 최대 연결 수 (Main은 제한 없음)
      MAX_CONNECTIONS: 0
    ports:
      - "${MAIN_API_PORT}:8000"       # FastAPI
      - "${MAIN_LIVEKIT_PORT}:7880"   # LiveKit HTTP/WebSocket
      - "${MAIN_RTC_PORT_START}-${MAIN_RTC_PORT_END}:50000-50020/udp"  # LiveKit RTC
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - recordings:/recordings
      - screenshots:/screenshots
    # Linux에서 host.docker.internal 해석 (호스트 IP 자동 감지 시 사용, 172.x 로 풀림)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - airclass-network
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=main"
      - "airclass.livekit=true"


  # ============================================
  # Sub Node 1 - FastAPI + LiveKit (통합 노드)
  # Main 노드에 자동 등록하여 부하 분산
  # ============================================
  sub-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-sub-1
    environment:
      # 클러스터 설정
      MODE: sub
      NODE_NAME: node-1
      NODE_HOST: sub-1
      NODE_PORT: 8000
      MAIN_NODE_URL: http://main:8000
      
      # LiveKit 설정
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET}
      LIVEKIT_URL: ws://sub-1:7890
      LIVEKIT_BINARY: /usr/local/bin/livekit-server
      LIVEKIT_PORT: 7890
      LIVEKIT_RTC_PORT_START: 51000
      LIVEKIT_RTC_PORT_END: 51020
      
      # Redis & MongoDB
      REDIS_URL: redis://redis:6379
      MONGO_URL: mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@mongodb:27017/airclass?authSource=admin
      
      # 보안 설정
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      CLUSTER_SECRET: ${CLUSTER_SECRET}
      
      # 네트워크 설정
      CORS_ORIGINS: ${CORS_ORIGINS}
      SERVER_IP: ${SERVER_IP}
      
      # Sub 노드 수용 인원
      MAX_CONNECTIONS: 150
    ports:
      - "${SUB1_API_PORT}:8000"        # FastAPI
      - "${SUB1_LIVEKIT_PORT}:7890"    # LiveKit HTTP/WebSocket
      - "${SUB1_RTC_PORT_START}-${SUB1_RTC_PORT_END}:51000-51020/udp"  # LiveKit RTC
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - recordings:/recordings
      - screenshots:/screenshots
    networks:
      - airclass-network
    depends_on:
      redis:
        condition: service_healthy
      main:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=sub"
      - "airclass.livekit=true"

  frontend:
    image: node:20-alpine
    container_name: airclass-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    networks:
      - airclass-network
    environment:
      VITE_BACKEND_URL: ${VITE_BACKEND_URL}
      BACKEND_HOST: main
      MEDIAMTX_HOST: main
    depends_on:
      - main
    restart: unless-stopped
    labels:
      - "airclass.role=frontend"


networks:
  airclass-network:
    driver: bridge

volumes:
  mongodb-data:
  mongodb-config:
  redis-data:
  recordings:
  screenshots:
