# AIRClass Docker Compose - Main-Sub Architecture with Redis
# 사용법:
#   기본 실행 (Main 1대, Sub 2대, Redis): docker-compose up
#   확장: docker-compose up --scale sub=5
#   종료: docker-compose down

version: '3.8'

services:
  # ============================================
  # Redis - 메시지 브로커 & 캐시
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: airclass-redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - airclass-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      - "airclass.role=redis"

  # ============================================
  # Main Node - 녹화 & 클러스터 관리
  # ============================================
  main:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-main-node
    environment:
      # 기본 설정
      MODE: main
      NODE_NAME: main
      NODE_HOST: main
      NODE_PORT: 8000
      
      # 스트리밍 설정
      RTMP_PORT: 1935
      WEBRTC_PORT: 8889
      WEBRTC_UDP_PORT: 8189
      
      # 녹화 설정 (Main의 핵심 역할)
      RECORDING_ENABLED: "true"
      RECORDING_DIR: /recordings
      SCREENSHOT_INTERVAL: 10  # 10초마다 스크린샷
      
      # 보안 설정
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
      
      # 네트워크 설정
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      SERVER_IP: ${SERVER_IP:-localhost}
      
      # Redis 연결
      REDIS_URL: redis://redis:6379
      
      # 최대 연결 수 (Main은 제한 없음)
      MAX_CONNECTIONS: 0
    ports:
      - "8000:8000"       # API
      - "1935:1935"       # RTMP (Android 앱용)
      - "8889:8889"       # WebRTC HTTP
      - "8189:8189/udp"   # WebRTC UDP
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - recordings:/recordings  # 녹화 파일 저장
      - screenshots:/screenshots  # 스크린샷 저장
    networks:
      - airclass-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=main"


  # ============================================
  # Sub Nodes - 실시간 스트림 배포 (필수 구성)
  # ============================================
  sub-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-sub-1
    environment:
      MODE: sub
      MAIN_URL: http://main:8000
      NODE_NAME: sub-1
      NODE_HOST: sub-1
      NODE_PORT: 8000
      NODE_SEQUENTIAL: 1
      
      # 스트리밍 설정
      WEBRTC_PORT: 8889
      WEBRTC_UDP_PORT: 8190
      
      # Redis 연결
      REDIS_URL: redis://redis:6379
      
      # 보안 설정
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
      
      # 네트워크 설정
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      SERVER_IP: ${SERVER_IP:-localhost}
      
      # Sub 노드 수용 인원
      MAX_CONNECTIONS: 150
    ports:
      - "8001:8000"       # API
      - "8890:8889"       # WebRTC HTTP
      - "8190:8190/udp"   # WebRTC UDP
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - recordings:/recordings
      - screenshots:/screenshots
    networks:
      - airclass-network
    depends_on:
      redis:
        condition: service_healthy
      main:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=sub"

  sub-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-sub-2
    environment:
      MODE: sub
      MAIN_URL: http://main:8000
      NODE_NAME: sub-2
      NODE_HOST: sub-2
      NODE_PORT: 8000
      NODE_SEQUENTIAL: 2
      
      # 스트리밍 설정
      WEBRTC_PORT: 8889
      WEBRTC_UDP_PORT: 8191
      
      # Redis 연결
      REDIS_URL: redis://redis:6379
      
      # 보안 설정
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
      
      # 네트워크 설정
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      SERVER_IP: ${SERVER_IP:-localhost}
      
      # Sub 노드 수용 인원
      MAX_CONNECTIONS: 150
    ports:
      - "8002:8000"       # API
      - "8891:8889"       # WebRTC HTTP
      - "8191:8191/udp"   # WebRTC UDP
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - recordings:/recordings
      - screenshots:/screenshots
    networks:
      - airclass-network
    depends_on:
      redis:
        condition: service_healthy
      main:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=sub"


  # ============================================
  # Frontend - 사용자 인터페이스
  # ============================================
  frontend:
    image: node:20-alpine
    container_name: airclass-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    networks:
      - airclass-network
    environment:
      VITE_BACKEND_URL: ${VITE_BACKEND_URL:-http://localhost:8000}
      BACKEND_HOST: main
      MEDIAMTX_HOST: main
    depends_on:
      - main
    restart: unless-stopped
    labels:
      - "airclass.role=frontend"


networks:
  airclass-network:
    driver: bridge

volumes:
  redis-data:
  recordings:
  screenshots:
