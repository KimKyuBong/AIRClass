# AIRClass Docker Compose - Main-Sub Architecture
# 사용법:
#   기본 실행 (Main 1대, Sub 3대): docker-compose up
#   확장: docker-compose up --scale sub=5
#   종료: docker-compose down

version: '3.8'

services:
  # ============================================
  # Main Node - 요청 라우팅 & 클러스터 관리
  # ============================================
  main:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-main-node
    environment:
      MODE: main
      NODE_NAME: main
      NODE_HOST: main
      USE_MAIN_WEBRTC: "false"  # Load balancing enabled: distribute to Sub nodes
      WEBRTC_PORT: 8889
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      # CORS 설정: 개발 환경에서는 "*", 프로덕션에서는 특정 origin 지정
      # 예: CORS_ORIGINS=http://192.168.1.100:5173,http://localhost:5173
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      # 서버 IP 주소 (WebRTC URL 생성에 사용)
      SERVER_IP: ${SERVER_IP:-localhost}
      # 클러스터 보안 키 (Main-Sub 노드 간 인증)
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
    ports:
      - "8000:8000"  # API 포트
      - "1935:1935"  # RTMP 포트 (Android 앱용)
      - "8889:8889"  # WebRTC HTTP 포트
      - "8189:8189/udp"  # WebRTC UDP 포트
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker 소켓 마운트 (외부 포트 감지용)
    networks:
      - airclass-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=main"


  # ============================================
  # Sub Nodes - 실제 스트리밍 처리 (고정 포트)
  # ============================================
  sub-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-sub-1
    environment:
      MODE: sub
      MAIN_URL: http://main:8000
      NODE_NAME: sub-1
      NODE_HOST: sub-1
      NODE_PORT: 8000
      RTMP_PORT: 1935
      WEBRTC_PORT: 8889
      WEBRTC_UDP_PORT: 8190  # 고정 UDP 포트
      MAX_CONNECTIONS: 150
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      SERVER_IP: ${SERVER_IP:-localhost}
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
    ports:
      - "8001:8000"      # API
      - "8890:8889"      # WebRTC HTTP
      - "8190:8190/udp"  # WebRTC UDP (같은 포트 매핑)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - airclass-network
    depends_on:
      main:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=sub"

  sub-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-sub-2
    environment:
      MODE: sub
      MAIN_URL: http://main:8000
      NODE_NAME: sub-2
      NODE_HOST: sub-2
      NODE_PORT: 8000
      RTMP_PORT: 1935
      WEBRTC_PORT: 8889
      WEBRTC_UDP_PORT: 8191  # 고정 UDP 포트
      MAX_CONNECTIONS: 150
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      SERVER_IP: ${SERVER_IP:-localhost}
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
    ports:
      - "8002:8000"      # API
      - "8891:8889"      # WebRTC HTTP
      - "8191:8191/udp"  # WebRTC UDP (같은 포트 매핑)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - airclass-network
    depends_on:
      main:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=sub"

  sub-3:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: airclass-sub-3
    environment:
      MODE: sub
      MAIN_URL: http://main:8000
      NODE_NAME: sub-3
      NODE_HOST: sub-3
      NODE_PORT: 8000
      RTMP_PORT: 1935
      WEBRTC_PORT: 8889
      WEBRTC_UDP_PORT: 8192  # 고정 UDP 포트
      MAX_CONNECTIONS: 150
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-secret-key-in-production}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      SERVER_IP: ${SERVER_IP:-localhost}
      CLUSTER_SECRET: ${CLUSTER_SECRET:-airclass2025}
    ports:
      - "8003:8000"      # API
      - "8892:8889"      # WebRTC HTTP
      - "8192:8192/udp"  # WebRTC UDP (같은 포트 매핑)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - airclass-network
    depends_on:
      main:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "airclass.role=sub"


  # ============================================
  # Frontend (Optional - 개발용)
  # ============================================
  frontend:
    image: node:20-alpine
    container_name: airclass-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    networks:
      - airclass-network
    environment:
      # 내부 네트워크에서 접속시: VITE_BACKEND_URL=http://서버IP:8000 설정
      # 예: VITE_BACKEND_URL=http://10.100.0.146:8000
      - VITE_BACKEND_URL=${VITE_BACKEND_URL:-http://localhost:8000}
    restart: unless-stopped
    labels:
      - "airclass.role=frontend"


  # ============================================
  # Monitoring (Optional - Grafana + Prometheus)
  # ============================================
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: airclass-prometheus
  #   volumes:
  #     - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
  #   ports:
  #     - "9090:9090"
  #   networks:
  #     - airclass-network


  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: airclass-grafana
  #   ports:
  #     - "3000:3000"
  #   networks:
  #     - airclass-network
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin


networks:
  airclass-network:
    driver: bridge


# ============================================
# 볼륨 (데이터 영속성)
# ============================================
volumes:
  prometheus-data:
  grafana-data:
