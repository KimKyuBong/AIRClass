<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRClass Teacher Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        :root { --primary-color: #3ea6ff; --bg-color: #1a1a1a; --panel-bg: #2a2a2a; --text-color: #fff; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 15px 20px; background-color: #111; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .brand { font-weight: 800; font-size: 1.2rem; color: #fff; display: flex; gap: 10px; }
        .brand i { color: var(--primary-color); }

        .dashboard { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        
        .panel { background: var(--panel-bg); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; color: #aaa; border-bottom: 1px solid #444; padding-bottom: 10px; }

        /* Left Column: Monitoring & Quiz */
        .video-wrapper { width: 100%; aspect-ratio: 16/9; background: #000; margin-bottom: 20px; border-radius: 4px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: contain; }

        .quiz-form { display: flex; flex-direction: column; gap: 10px; }
        .quiz-tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        input, select { padding: 10px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; }
        button { padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0055aa; }
        .btn-ai { background: #9b59b6; padding: 5px 10px; font-size: 0.8rem; }
        .btn-capture { background: #e67e22; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }

        /* Capture Modal */
        .capture-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .capture-container { width: 80%; max-width: 800px; height: 60vh; background: #000; margin-bottom: 20px; }
        .capture-img { max-width: 100%; max-height: 100%; display: block; }
        .capture-controls { display: flex; gap: 10px; }

        /* Right Column: Interaction Feed */
        .feed-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        /* ... existing feed styles ... */
        .feed-item { background: #333; padding: 10px; border-radius: 4px; border-left: 3px solid #555; }
        .feed-item.question { border-left-color: #e67e22; }
        .feed-item.result { border-left-color: #2ecc71; }
        .feed-meta { font-size: 0.8rem; color: #888; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .feed-content { font-size: 0.95rem; }

        /* Status Bar */
        .status-bar { display: flex; gap: 20px; font-size: 0.9rem; color: #888; margin-bottom: 10px; }
        .status-item span { color: white; font-weight: bold; }

    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="fas fa-chalkboard-teacher"></i> AIRClass Teacher</div>
        <div class="status-bar">
            <div class="status-item">Students: <span id="student-count">0</span></div>
            <div class="status-item">Monitors: <span id="monitor-count">0</span></div>
        </div>
    </header>

    <div class="dashboard">
        <!-- Left: Monitoring & Quiz -->
        <div class="panel">
            <div class="panel-title">Class Monitor & Quiz</div>
            
            <div class="video-wrapper">
                <video id="video" autoplay playsinline muted crossorigin="anonymous"></video>
            </div>

            <div class="quiz-form">
                <div class="quiz-tools">
                    <span style="font-weight: bold; font-size: 0.9rem;">Quiz Maker</span>
                    <div>
                        <button class="btn-capture" onclick="startCapture()"><i class="fas fa-camera"></i> 화면 캡쳐로 만들기</button>
                        <button class="btn-ai" onclick="generateAiQuiz()">✨ AI로 만들기</button>
                    </div>
                </div>
                <input type="text" id="quiz-q" placeholder="퀴즈 질문을 입력하세요" value="">
                <input type="text" id="quiz-o1" placeholder="옵션 1" value="">
                <input type="text" id="quiz-o2" placeholder="옵션 2" value="">
                <input type="text" id="quiz-o3" placeholder="옵션 3" value="">
                <select id="quiz-a">
                    <option value="1">정답: 옵션 1</option>
                    <option value="2">정답: 옵션 2</option>
                    <option value="3">정답: 옵션 3</option>
                </select>
                <button onclick="sendQuiz()">퀴즈 전송하기</button>
            </div>
        </div>

        <!-- Right: Student Interaction -->
        <div class="panel">
            <div class="panel-title">Real-time Feed</div>
            <div class="feed-list" id="feed-list">
                <div class="feed-item">
                    <div class="feed-meta">System</div>
                    <div class="feed-content">수업 준비 완료</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Capture Modal -->
    <div id="capture-modal" class="capture-modal">
        <div class="capture-container">
            <img id="capture-target" class="capture-img">
        </div>
        <div class="capture-controls">
            <button onclick="closeCapture()" style="background: #555;">취소</button>
            <button onclick="processCapture()" class="btn-ai">선택 영역으로 퀴즈 생성</button>
        </div>
    </div>

    <script>
        // --- WebRTC Logic ---
        const video = document.getElementById('video');
        const streamPath = 'live/stream';
        const whepUrl = `http://${window.location.hostname}:8889/${streamPath}/whep`;
        
        async function startStream() {
            const peerConnection = new RTCPeerConnection({ iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] });
            peerConnection.addTransceiver('video', { direction: 'recvonly' });
            peerConnection.addTransceiver('audio', { direction: 'recvonly' });
            peerConnection.ontrack = (e) => video.srcObject = e.streams[0];
            
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                const res = await fetch(whepUrl, { method: 'POST', body: offer.sdp, headers: {'Content-Type':'application/sdp'} });
                if(res.ok) peerConnection.setRemoteDescription({ type:'answer', sdp: await res.text() });
            } catch(e) {}
        }
        startStream();

        // --- Capture & Crop Logic ---
        let cropper = null;

        function startCapture() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const modal = document.getElementById('capture-modal');
            const img = document.getElementById('capture-target');
            
            img.src = canvas.toDataURL('image/jpeg');
            modal.style.display = 'flex';

            if(cropper) cropper.destroy();
            cropper = new Cropper(img, {
                viewMode: 1,
                autoCropArea: 0.8,
            });
        }

        function closeCapture() {
            document.getElementById('capture-modal').style.display = 'none';
            if(cropper) cropper.destroy();
        }

        async function processCapture() {
            if(!cropper) return;
            const croppedCanvas = cropper.getCroppedCanvas();
            const base64Image = croppedCanvas.toDataURL('image/jpeg');
            
            closeCapture();
            await generateAiQuiz(base64Image);
        }

        // --- AI Quiz Logic ---
        async function generateAiQuiz(imageData = null) {
            let topic = "수업 내용";
            if (!imageData) {
                topic = prompt("어떤 주제로 퀴즈를 만들까요?", "임진왜란");
                if (!topic) return;
            } else {
                // 이미지가 있으면 주제 입력 없이 자동 분석하도록 하거나, 힌트로 줄 수 있음
                // 여기서는 간단히 '수업 화면'이라고 퉁치고 이미지를 보냄
            }

            const btn = document.querySelector('.quiz-tools button:last-child'); // AI Button reference might need better selector
            // Simply use global loading indicator or alert
            
            alert("AI가 이미지를 분석하고 퀴즈를 생성합니다... 잠시만 기다려주세요.");

            try {
                const res = await fetch('/api/ai/quiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic: topic,
                        image: imageData
                    })
                });
                
                if (!res.ok) throw new Error("서버 오류");
                const data = await res.json();
                
                document.getElementById('quiz-q').value = data.question;
                document.getElementById('quiz-o1').value = data.options[0] || "";
                document.getElementById('quiz-o2').value = data.options[1] || "";
                document.getElementById('quiz-o3').value = data.options[2] || "";
                
                const select = document.getElementById('quiz-a');
                if (data.answer <= 3) select.value = data.answer;
                
                alert("퀴즈 생성 완료! 내용을 확인하세요.");

            } catch (e) {
                alert("실패: " + e.message);
            }
        }

        // --- WebSocket Logic (Existing) ---
        const teacherId = "teacher_1";
        const wsUrl = `ws://${window.location.host}/ws/teacher/${teacherId}`;
        const socket = new WebSocket(wsUrl);

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            
            if (msg.type === "status") {
                document.getElementById('student-count').textContent = msg.student_count;
                document.getElementById('monitor-count').textContent = msg.monitor_count;
            } else if (msg.type === "question") {
                addFeedItem(msg.student_name, msg.text, "question", msg.image);
            } else if (msg.type === "quiz_result") {
                const resultText = msg.is_correct ? "✅ 정답!" : "❌ 오답 (" + msg.answer + ")";
                addFeedItem(msg.student_name, `퀴즈 제출: ${resultText}`, "result");
            }
        };

        function addFeedItem(name, content, type, image = null) {
            const list = document.getElementById('feed-list');
            const div = document.createElement('div');
            div.className = `feed-item ${type}`;
            
            let html = `
                <div class="feed-meta">
                    <span>${name}</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="feed-content">${content || (image ? "이미지 첨부" : "")}</div>
            `;
            if (image) {
                html += `<img src="${image}" style="max-width: 100%; border-radius: 4px; margin-top: 10px; border: 1px solid #555;">`;
            }
            div.innerHTML = html;
            list.prepend(div);
        }

        function sendQuiz() {
            const q = document.getElementById('quiz-q').value;
            const o1 = document.getElementById('quiz-o1').value;
            const o2 = document.getElementById('quiz-o2').value;
            const o3 = document.getElementById('quiz-o3').value;
            const a = document.getElementById('quiz-a').value;

            if (!q) return alert("질문을 입력하세요");

            const quizData = {
                id: "quiz_" + Date.now(),
                question: q,
                options: [o1, o2, o3],
                answer: parseInt(a)
            };

            socket.send(JSON.stringify({ type: "send_quiz", data: quizData }));
            addFeedItem("Me", `퀴즈 출제됨: ${q}`, "system");
        }
    </script>
</body>
</html>
